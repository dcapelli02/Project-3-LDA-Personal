---
title: "Exploratory Analysis on Missing Data"
author: "Guillem Olivart Garrofé"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: united
    highlight: tango
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

## 1. Libraries

```{r libraries}
library(haven)      # Dades SAS
library(dplyr)      # Manipulació Dades
library(tidyr)      # Transformacions (pivot_longer)
library(ggplot2)    # Gràfics
library(naniar)     # Missing Data 
library(VIM)        # Visualització Patrons
library(nlme)       # LMM 
library(lme4)       # GLMM 
library(geepack)    # GEE i WGEE 
library(mice)       # Sensitivity Analysis
library(corrplot)   # Matriu Correlació
```

## 2. Data Preparation

```{r load_data}
# DATASET
# Assegura't que la ruta és correcta
alz <- read_sas("C:/Users/win11/Documents/Guillem/Erasmus/Assignatures/Longitudinal Data Analysis/Project-3-LDA-Personal/alzheimer25.sas7bdat")

# Factor variables
alz$trial <- as.factor(alz$trial)
alz$sex <- as.factor(alz$sex)
alz$edu <- as.factor(alz$edu)
alz$job <- as.factor(alz$job)
alz$wzc <- as.factor(alz$wzc)
alz$adl <- as.factor(alz$adl)
alz$adl_num <- as.numeric(alz$adl)
alz$n_obs_data <- rowSums(!is.na(alz[, c(18:24)]))

# Bins
alz$cdrsb_bin0 <- ifelse(alz$cdrsb0 > 10, 1, 0)
alz$cdrsb_bin1 <- ifelse(alz$cdrsb1 > 10, 1, 0)
alz$cdrsb_bin2 <- ifelse(alz$cdrsb2 > 10, 1, 0)
alz$cdrsb_bin3 <- ifelse(alz$cdrsb3 > 10, 1, 0)
alz$cdrsb_bin4 <- ifelse(alz$cdrsb4 > 10, 1, 0)
alz$cdrsb_bin5 <- ifelse(alz$cdrsb5 > 10, 1, 0)
alz$cdrsb_bin6 <- ifelse(alz$cdrsb6 > 10, 1, 0)

# Baseline 
alz$ab_base <- alz$abpet0
alz$tau_base <- alz$taupet0
alz$cdrsb_base <- alz$cdrsb0
alz$bprs_base <- alz$bprs0
```

### Longitudinal Dataset

```{r longitudinal}
alz_long <- alz %>%
  pivot_longer(
    cols = matches(".*\\d+$"),     
    names_to = c(".value", "time"),
    names_pattern = "(.*)(\\d+)$"  
  ) %>%
  mutate(
    time = as.numeric(time),       
    id = as.factor(patid)         
  ) %>%
  arrange(id, time)

head(alz_long)
```

## 3. Exploratory Analysis on Missing Data

### General Behaviour

```{r missing_general}
# General pattern
alz %>%
  select(matches("\\d+$")) %>% 
  vis_miss() +
  labs(title = "Missingness Pattern") +
  theme(axis.text.x = element_text(angle = 90))

# Specific to CDRSB
alz %>%
  select(matches("cdrsb\\d+$")) %>% 
  vis_miss() +
  labs(title = "Missingness Pattern on cdrsb") +
  theme(axis.text.x = element_text(angle = 90))

# Percentages
alz_long %>%
  select(cdrsb, bprs, abpet, taupet) %>% 
  gg_miss_var(show_pct = TRUE) + 
  labs(title = "% Missing Data",
       y = "Missings' Percentage")
```

The missingness pattern is **equal** in every longitudinal variable.

### Dropout Analysis

```{r dropout_table}
dropout_table <- alz_long %>%
  group_by(time) %>%
  summarise(
    N_Total = n(),
    Observed_CDRSB = sum(!is.na(cdrsb)),
    Missing_CDRSB = sum(is.na(cdrsb)),
    Pct_Missing = round(mean(is.na(cdrsb)) * 100, 2)
  )

print(dropout_table)

ggplot(dropout_table, aes(x = time, y = Observed_CDRSB)) +
  geom_line(color = "blue", size = 1.2) +
  geom_point(size = 3) +
  labs(title = "Number of observed patients evolution",
       x = "Year", y = "Observed Patients") +
  theme_bw()
```

### Monotoneness Check

```{r monotone}
check_intermittent <- alz_long %>%
  select(id, time, cdrsb) %>%
  arrange(id, time) %>%
  group_by(id) %>%
  summarise(
    is_missing = list(is.na(cdrsb)),
    pattern = paste(as.integer(!is.na(cdrsb)), collapse = "")
  )
table(check_intermittent$pattern)
```

We conclude that missingness follows a **monotone** pattern.

## 4. Missingness per Covariates

```{r miss_factors, fig.height=6, fig.width=8}
# Trial
alz %>% select(trial, matches("cdrsb\\d+$")) %>%  
  gg_miss_fct(fct = trial) + labs(title = "% Missings by Trial")

# Sex (0 - men, 1 - women)
alz %>% select(sex, matches("cdrsb\\d+$")) %>%  
  gg_miss_fct(fct = sex) + labs(title = "% Missings by Sex")

# Age
alz %>% select(age, matches("cdrsb\\d+$")) %>%  
  gg_miss_fct(fct = age) + labs(title = "% Missings by Age")

# Edu
alz %>% select(edu, matches("cdrsb\\d+$")) %>%  
  gg_miss_fct(fct = edu) + labs(title = "% Missings by Edu")

# BMI
alz %>% select(bmi, matches("cdrsb\\d+$")) %>%  
  gg_miss_fct(fct = bmi) + labs(title = "% Missings by BMI")

# Inkomen
alz %>% select(inkomen, matches("cdrsb\\d+$")) %>%  
  gg_miss_fct(fct = inkomen) + labs(title = "% Missings by Inkomen")

# Job
alz %>% select(job, matches("cdrsb\\d+$")) %>%  
  gg_miss_fct(fct = job) + labs(title = "% Missings by Job")

# ADL
alz %>% select(adl, matches("cdrsb\\d+$")) %>%  
  gg_miss_fct(fct = adl) + labs(title = "% Missings by ADL")

# WZC (0 - home, 1 - residence)
alz %>% select(wzc, matches("cdrsb\\d+$")) %>%  
  gg_miss_fct(fct = wzc) + labs(title = "% Missings by WZC")
```

## 5. Mean Profiles by Dropout Time

```{r mean_profiles}
dropout_info <- alz_long %>%
  group_by(id) %>%
  summarise(
    first_missing = ifelse(any(is.na(cdrsb)), 
                           as.character(min(time[is.na(cdrsb)])),
                           "Complete")
  )

alz_patterns <- left_join(alz_long, dropout_info, by = "id")

# Function to reuse code
plot_mean_profile <- function(data, var, title) {
  data %>%
    group_by(time, first_missing) %>%
    summarise(mean_val = mean({{var}}, na.rm = TRUE), .groups = 'drop') %>%
    ggplot(aes(x = time, y = mean_val, color = as.factor(first_missing))) +
    geom_line(size = 1) +
    geom_point() +
    labs(title = title, x = "Year", y = "Mean Value", color = "Dropout Time") +
    theme_bw()
}

plot_mean_profile(alz_patterns, cdrsb, "CDRSB Mean's evolution")
plot_mean_profile(alz_patterns, bprs, "BPRS Mean's evolution")
plot_mean_profile(alz_patterns, taupet, "TAUPET Mean's evolution")
plot_mean_profile(alz_patterns, abpet, "ABPET Mean's evolution")
```

This may suggest us that we do **not** have a **MCAR** case, because patients who drop out have higher means (worse condition) than the completers.

## 6. Dropout Mechanism Analysis

### Evidence for MAR (Boxplots)

```{r mar_evidence}
alz_long_lag <- alz_long %>%
  group_by(id) %>%
  mutate(
    is_missing_next = lead(is.na(cdrsb)) 
  ) %>%
  filter(time < max(time)) 

# Boxplot CDRSB
ggplot(alz_long_lag, aes(x = as.factor(time), y = cdrsb, fill = is_missing_next)) +
  geom_boxplot() +
  labs(title = "Evidence for MAR in CDRSB", x = "Year", y = "CDRSB", fill = "Missing at t+1?") +
  scale_fill_manual(values = c("skyblue", "salmon"), na.value="grey") +
  theme_minimal()

# Boxplot BPRS
ggplot(alz_long_lag, aes(x = as.factor(time), y = bprs, fill = is_missing_next)) +
  geom_boxplot() +
  labs(title = "Evidence for MAR in BPRS", x = "Year", y = "BPRS", fill = "Missing at t+1?") +
  scale_fill_manual(values = c("skyblue", "salmon"), na.value="grey") +
  theme_minimal()

# Boxplot TAUPET
ggplot(alz_long_lag, aes(x = as.factor(time), y = taupet, fill = is_missing_next)) +
  geom_boxplot() +
  labs(title = "Evidence for MAR in TAUPET", x = "Year", y = "TAUPET", fill = "Missing at t+1?") +
  scale_fill_manual(values = c("skyblue", "salmon"), na.value="grey") +
  theme_minimal()

# Boxplot ABPET
ggplot(alz_long_lag, aes(x = as.factor(time), y = abpet, fill = is_missing_next)) +
  geom_boxplot() +
  labs(title = "Evidence for MAR in ABPET", x = "Year", y = "ABPET", fill = "Missing at t+1?") +
  scale_fill_manual(values = c("skyblue", "salmon"), na.value="grey") +
  theme_minimal()
```

This suggests **MAR**, because the red boxes are higher than the blue ones. The patients that are worse leave the study.

### Logistic Dropout Model

```{r dropout_model}
alz_dropout_model <- alz_long %>%
  group_by(id) %>%
  mutate(
    is_missing = is.na(cdrsb),          
    prev_cdrsb = lag(cdrsb),            
    prev_bprs = lag(bprs) ,
    prev_taupet = lag(taupet),
    prev_abpet = lag(abpet)
  ) %>%
  filter(time > 0) %>% 
  ungroup()

model_dropout <- glm(is_missing ~ prev_cdrsb + prev_bprs + prev_taupet + prev_abpet +
                                  trial + sex + age + edu + bmi + inkomen + job + adl_num + wzc + time, 
                     data = alz_dropout_model, 
                     family = binomial)

summary(model_dropout)
```

Since we have that the p-value of `prev_cdrsb` \< 2e-16\*, we have evidence of **MAR\*\***. Since the estimate for `prev_cdrsb` = 0.1209 \> 0, patients with higher cdrsb tend to dropout more.

### MCAR Tests (Little's Test)

```{r mcar_tests}
mcar_cdrsb <- mcar_test(alz %>% select(matches("cdrsb\\d+$")))
mcar_bprs <- mcar_test(alz %>% select(matches("bprs\\d+$")))
mcar_taupet <- mcar_test(alz %>% select(matches("taupet\\d+$")))
mcar_abpet <- mcar_test(alz %>% select(matches("abpet\\d+$")))

print(mcar_cdrsb)
print(mcar_bprs)
print(mcar_taupet)
print(mcar_abpet)
```

Since the p-values of these tests are \~ 0, we conclude that we do **not** have a **MCAR** case.

## 7. Baseline Comparison: Completers vs Dropouts

```{r baseline_comp}
completers_id <- alz_long %>%
  filter(time == 6 & !is.na(cdrsb)) %>%
  pull(patid)

alz_comparison <- alz %>%
  mutate(
    Status = ifelse(patid %in% completers_id, "Completer", "Dropout")
  )

comp_table <- alz_comparison %>%
  group_by(Status) %>%
  summarise(
    N = n(),
    CDRSB_Base = mean(cdrsb0, na.rm=TRUE),
    BPRS_Base = mean(bprs0, na.rm=TRUE),
    Age_Mean = mean(age, na.rm=TRUE),
    ADL_Mean = mean(adl_num, na.rm = TRUE)
  )

knitr::kable(comp_table, digits = 2)
```

The descriptive comparison reveals that the **dropout group** had a higher mean Age and higher baseline BPRS scores, while conversely presenting a lower mean baseline CDRSB and lower ADL scores.

## 8. Additional Visualizations

### Spaghetti Plots

```{r spaghetti}
set.seed(123)
random_ids <- sample(unique(alz_long$patid), 30)

sample_data <- alz_long %>% 
  filter(patid %in% random_ids)

# CDRSB Individual
ggplot(sample_data, aes(x = time, y = cdrsb_bin, group = patid, color = as.factor(patid))) +
  geom_line(alpha = 0.7) +
  geom_point() +
  theme_bw() +
  theme(legend.position = "none") + 
  labs(title = "Trajectories of CDRSB (Sample)", y = "CDRSB", x = "Year")

# CDRSB Mean Trend
ggplot(sample_data, aes(x = time, y = cdrsb_bin, group = patid)) +
  geom_line(alpha = 0.2) +  
  stat_summary(aes(group = 1), fun = mean, geom = "line", color = "red", size = 1.2) +
  labs(title = "Individual Trajectories + Mean (CDRSB Bin)",
       y = "CDRSB_bin", x = "Year") +
  theme_bw()

# BPRS Individual
ggplot(sample_data, aes(x = time, y = bprs, group = patid, color = as.factor(patid))) +
  geom_line(alpha = 0.7) +
  geom_point() +
  theme_bw() +
  theme(legend.position = "none") + 
  labs(title = "Trajectories of BPRS (Sample)", y = "BPRS", x = "Year")
```

### Correlation Matrices

```{r correlation}
# CDRSB
cor_data_cdrsb <- alz %>%
  select(matches("cdrsb_bin\\d+$")) %>% 
  na.omit() 

cor_matrix_cdrsb <- round(cor(cor_data_cdrsb), 2)
corrplot(cor_matrix_cdrsb, 
         title = "CDRSB Bin Correlation",
         method = "number", type = "upper", tl.cex = 0.7, mar=c(0,0,1,0))

# BPRS
cor_data_bprs <- alz %>%
  select(matches("bprs\\d+$")) %>% 
  na.omit() 

cor_matrix_bprs <- round(cor(cor_data_bprs), 2)
corrplot(cor_matrix_bprs, 
         title = "BPRS Correlation Matrix",
         method = "number", type = "upper", tl.cex = 0.7, mar=c(0,0,1,0))
```

### Distributions

```{r distribution}
# CDRSB Barplot
ggplot(alz_long, aes(x = as.factor(cdrsb_bin), fill = as.factor(cdrsb_bin))) +
  geom_bar() +                                
  facet_wrap(~time) + 
  labs(title = "CDRSB_bin Distribution over Time", 
       y = "Number of Patients",
       x = "CDRSB_bin",
       fill = "State") +
  theme_bw()

# BPRS Histogram
ggplot(alz_long, aes(x = bprs)) +
  geom_histogram(binwidth = 1, fill = "steelblue", color = "white") +
  facet_wrap(~time) + 
  labs(title = "BPRS Distribution over Time", y = "Number of Patients") +
  theme_bw()
```
